<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Lista de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .product-options {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .product-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
        }
        .product-option:hover {
            background-color: #e9ecef;
        }
        .selected-option {
            background-color: #e3f2fd;
            border-color: #90caf9;
        }
    </style>
</head>
<body>
    <script src="js/navbar.js"></script>
    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div id="list-details">
                    <!-- El contenido se cargará dinámicamente -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver opciones de producto -->
    <div class="modal fade" id="productOptionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productOptionsModalTitle">Opciones de Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productOptionsModalBody">
                    <div id="productOptionsContent">
                        <!-- El contenido se cargará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar producto -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3">
                            <label for="editProductName" class="form-label">Nombre del Producto</label>
                            <input type="text" class="form-control" id="editProductName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductQuantity" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="editProductQuantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductCategory" class="form-label">Categoría</label>
                            <select class="form-select" id="editProductCategory" required>
                                <option value="Papelería">Papelería</option>
                                <option value="Escritura">Escritura</option>
                                <option value="Geometría">Geometría</option>
                                <option value="Manualidades">Manualidades</option>
                                <option value="Organización">Organización</option>
                                <option value="Matemáticas">Matemáticas</option>
                                <option value="Tecnología">Tecnología</option>
                                <option value="Arte">Arte</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveProductEdit()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/config.js"></script>
    <script>
        // Variables globales
        let currentListId = null;
        const productOptionsModal = new bootstrap.Modal(document.getElementById('productOptionsModal'));
        const editProductModal = new bootstrap.Modal(document.getElementById('editProductModal'));

        // Insertar navbar al cargar la página
        document.addEventListener('DOMContentLoaded', async () => {
            insertNavbar();
            // Mostrar productos realmente agregados si existen en localStorage
            const addedItems = JSON.parse(localStorage.getItem('addedItems') || '[]');
            if (addedItems.length > 0) {
                let mensaje = 'Productos AGREGADOS a la lista:\n\n';
                addedItems.forEach(item => {
                    mensaje += `- ${item.name} (cantidad: ${item.quantity})\n`;
                });
                alert(mensaje);
                localStorage.removeItem('addedItems');
            }
            // Mostrar productos sin stock si existen en localStorage
            const noStockItems = JSON.parse(localStorage.getItem('noStockItems') || '[]');
            if (noStockItems.length > 0) {
                let mensaje = 'Los siguientes productos NO se agregaron por falta de stock:\n\n';
                noStockItems.forEach(item => {
                    mensaje += `- ${item.name} (solicitado: ${item.quantity_requested}, disponible: ${item.stock_disponible})\n`;
                });
                alert(mensaje);
                localStorage.removeItem('noStockItems');
            }
            const pathParts = window.location.pathname.split('/');
            currentListId = pathParts[pathParts.length - 1];
            
            if (currentListId) {
                await loadListDetails();
            }
        });

        // Cargar detalles de la lista
        async function loadListDetails() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/shopping/${currentListId}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('list-name-display').textContent = data.list.name;
                    renderItems(data.items);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error cargando detalles:', error);
                document.getElementById('list-details').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Ver detalles de un producto (antes viewProductOptions)
        async function viewProductDetails(productId) {
            const modalTitle = document.getElementById('productOptionsModalTitle');
            const modalBody = document.getElementById('productOptionsModalBody');
            
            modalTitle.textContent = 'Detalles del Producto';
            modalBody.innerHTML = `<div class="text-center"><div class="spinner-border"></div></div>`;
            productOptionsModal.show();

            try {
                // Obtener todos los productos del inventario una vez si no los tenemos
                if (!window.inventoryProducts) {
                    const invRes = await fetch('/api/products');
                    const invData = await invRes.json();
                    if (invData.success) {
                        window.inventoryProducts = invData.products;
                    } else {
                        window.inventoryProducts = [];
                    }
                }

                // Primero, obtener el item de la lista para saber cuál es el `inventory_product_id`
                const itemRes = await fetch(`/api/shopping/${currentListId}/items/${productId}`);
                const itemData = await itemRes.json();

                if (!itemData.success) {
                    throw new Error('No se pudo cargar el ítem de la lista.');
                }

                const inventoryId = itemData.item.inventory_product_id;
                const product = window.inventoryProducts.find(p => p.id === inventoryId);

                if (product) {
                    modalBody.innerHTML = `
                        <h4>${product.name}</h4>
                        <p>${product.description || 'Este producto no tiene una descripción detallada.'}</p>
                        <hr>
                        <p><strong>Marca:</strong> ${product.brand || 'N/A'}</p>
                        <p><strong>Precio:</strong> $${product.price ? product.price.toFixed(2) : 'N/A'}</p>
                        <p><strong>Categoría de Calidad:</strong> ${product.quality_category || 'N/A'}</p>
                    `;
                } else {
                    modalBody.innerHTML = `<div class="alert alert-warning">No se encontró el producto en el inventario.</div>`;
                }
            } catch (error) {
                console.error('Error al ver detalles:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">Error al cargar los detalles del producto: ${error.message}</div>`;
            }
        }

        // Editar producto (ahora es "Buscar Alternativas")
        async function findAlternatives(productId) {
            const modalTitle = document.getElementById('productOptionsModalTitle');
            const modalBody = document.getElementById('productOptionsModalBody');
            
            modalTitle.textContent = 'Buscar Alternativas';
            modalBody.innerHTML = `<div class="text-center"><div class="spinner-border"></div></div>`;
            productOptionsModal.show();

            try {
                const response = await fetch(`${API_BASE_URL}/api/shopping/${currentListId}/items/${productId}/alternatives`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                if (data.alternatives.length === 0) {
                    modalBody.innerHTML = `<div class="alert alert-info">No se encontraron alternativas para este producto.</div>`;
                    return;
                }

                modalBody.innerHTML = `
                    <p class="text-muted">Se encontraron ${data.alternatives.length} alternativas. Selecciona una para reemplazar el producto actual en tu lista.</p>
                    <div class="list-group">
                        ${data.alternatives.map(alt => `
                            <a href="#" onclick="replaceProduct('${productId}', '${alt.id}')" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${alt.name}</h5>
                                    <small class="text-success">$${alt.price.toFixed(2)}</small>
                                </div>
                                <p class="mb-1">${alt.description || 'Sin descripción.'}</p>
                                <small>Marca: ${alt.brand} - Calidad: ${alt.quality_category}</small>
                            </a>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('Error buscando alternativas:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">Error al buscar alternativas: ${error.message}</div>`;
            }
        }

        async function replaceProduct(originalItemId, newProductId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/shopping/${currentListId}/items/${originalItemId}/replace`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_product_id: newProductId })
                });

                const result = await response.json();

                if (result.success) {
                    productOptionsModal.hide();
                    loadListDetails(); // Recargar la lista para ver el cambio
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert(`Error al reemplazar el producto: ${error.message}`);
            }
        }

        // Eliminar producto
        async function deleteProduct(productId) {
            // Creamos un modal simple para confirmar y mostrar errores
            let modalDiv = document.createElement('div');
            modalDiv.innerHTML = `
            <div class='modal fade' id='modalEliminarProducto' tabindex='-1'>
                <div class='modal-dialog'>
                    <div class='modal-content'>
                        <div class='modal-header'>
                            <h5 class='modal-title'>Eliminar producto</h5>
                            <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
                        </div>
                        <div class='modal-body' id='deleteProductModalBody'>
                            ¿Estás seguro de que deseas eliminar este producto?
                        </div>
                        <div class='modal-footer'>
                            <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancelar</button>
                            <button type='button' class='btn btn-danger' id='confirmDeleteProductBtn'>Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>`;
            document.body.appendChild(modalDiv);
            let modal = new bootstrap.Modal(modalDiv.querySelector('#modalEliminarProducto'));
            modal.show();
            modalDiv.querySelector('#confirmDeleteProductBtn').addEventListener('click', async function() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/shopping/${currentListId}/items/${productId}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (data.success) {
                        modal.hide();
                        setTimeout(()=>modalDiv.remove(), 300);
                        loadListDetails(); // Recargar la lista para ver los cambios
                    } else {
                        throw new Error(data.message || 'Error al eliminar el producto');
                    }
                } catch (error) {
                    console.error('Error eliminando producto:', error);
                    document.getElementById('deleteProductModalBody').innerHTML = `<div class='alert alert-danger'>Error al eliminar el producto: ${error.message}</div>`;
                }
            });
            // Limpiar modal al cerrar
            modalDiv.querySelector('.btn-close').addEventListener('click', function() {
                setTimeout(()=>modalDiv.remove(), 300);
            });
            modalDiv.querySelector('.btn-secondary').addEventListener('click', function() {
                setTimeout(()=>modalDiv.remove(), 300);
            });
        }

        // Eliminar lista
        async function deleteList(listId) {
            if (!confirm('¿Estás seguro de que deseas eliminar esta lista?')) {
                return;
            }

            try {
                const response = await fetch(`/api/shopping/${listId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/home.html';
                } else {
                    throw new Error(data.message || 'Error al eliminar la lista');
                }
            } catch (error) {
                console.error('Error al eliminar la lista:', error);
                alert('Error al eliminar la lista: ' + error.message);
            }
        }
    </script>
</body>
</html> 